<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>UK Power & Cell Infrastructure Map</title>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
  <style>
    html,
    body {
      margin: 0;
      height: 100%;
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
    }
    #map {
      width: 100%;
      height: 100vh;
    }

    .legend {
      position: absolute;
      bottom: 20px;
      left: 20px;
      background: white;
      padding: 10px 14px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.25);
      font-size: 14px;
      font-weight: 600;
      color: #222;
      user-select: none;
      z-index: 1000;
      min-width: 150px;
    }

    .legend div {
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .legend .icon {
      width: 18px;
      height: 18px;
      border-radius: 50%;
    }

    .popup-title {
      font-weight: bold;
      font-size: 16px;
      margin-bottom: 6px;
      color: #0055aa;
    }

    .popup-body {
      font-size: 14px;
      color: #333;
    }

    /* Marker cluster style override */
    .marker-cluster-small {
      background-color: rgba(255, 69, 0, 0.6);
      color: white;
      border: 2px solid #d44100;
    }
    .marker-cluster-medium {
      background-color: rgba(255, 140, 0, 0.7);
      color: white;
      border: 2px solid #c77400;
    }
    .marker-cluster-large {
      background-color: rgba(255, 215, 0, 0.8);
      color: black;
      border: 2px solid #bfa600;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <!-- Legend -->
  <div class="legend">
    <div><span class="icon" style="background: red;"></span> Substation</div>
    <div><span class="icon" style="background: blue;"></span> Cell Tower</div>
  </div>

  <!-- Leaflet & Plugins -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

  <script>
    // Map setup
    const map = L.map("map").setView([53.0, -1.25], 7);

    // Base layers
    const esriSat = L.tileLayer(
      "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
      { maxZoom: 20, attribution: "&copy; Esri, NASA, NGA, USGS" }
    ).addTo(map);

    const osm = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
      attribution: "&copy; OpenStreetMap contributors",
    });

    const topo = L.tileLayer("https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png", {
      maxZoom: 17,
      attribution:
        "Map data: &copy; OpenStreetMap contributors, SRTM | Map style: &copy; OpenTopoMap (CC-BY-SA)",
    });

    // Embedded SVG icons as Data URLs (16x16 px)

    const substationSvg = encodeURIComponent(`
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64" fill="red">
        <circle cx="32" cy="32" r="30" stroke="darkred" stroke-width="4" fill="red"/>
        <rect x="26" y="20" width="12" height="24" fill="white" />
      </svg>
    `);

    const cellTowerSvg = encodeURIComponent(`
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64" fill="blue">
        <circle cx="32" cy="32" r="30" stroke="darkblue" stroke-width="4" fill="blue"/>
        <polygon points="32,12 28,52 36,52" fill="white"/>
      </svg>
    `);

    // Create Leaflet icons from data URLs
    const substationIcon = L.icon({
      iconUrl: `data:image/svg+xml,${substationSvg}`,
      iconSize: [16, 16],
      iconAnchor: [8, 8],
      popupAnchor: [0, -8],
    });

    const cellTowerIcon = L.icon({
      iconUrl: `data:image/svg+xml,${cellTowerSvg}`,
      iconSize: [16, 16],
      iconAnchor: [8, 8],
      popupAnchor: [0, -8],
    });

    // Create ONE marker cluster group for all markers
    const allMarkers = L.markerClusterGroup();

    // Fetch JSON data and add markers dynamically
    fetch("data.json")
      .then((response) => {
        if (!response.ok) throw new Error("Failed to load data.json");
        return response.json();
      })
      .then((data) => {
        // Add substations
        data.substations.forEach((site) => {
          const marker = L.marker([site.Latitude, site.Longitude], {
            icon: substationIcon,
          }).bindPopup(
            `<div class="popup-title">${site.Name} (${site.SiteNumber})</div>
             <div class="popup-body">${site.Info}</div>
             <div class="popup-body">Coords: ${site.Latitude.toFixed(5)}, ${site.Longitude.toFixed(5)}</div>`
          );
          allMarkers.addLayer(marker);
        });

        // Add cell towers
        data.cellTowers.forEach((site) => {
          const marker = L.marker([site.Latitude, site.Longitude], {
            icon: cellTowerIcon,
          }).bindPopup(
            `<div class="popup-title">${site.Name} (${site.SiteNumber})</div>
             <div class="popup-body">${site.Info}</div>
             <div class="popup-body">Coords: ${site.Latitude.toFixed(5)}, ${site.Longitude.toFixed(5)}</div>`
          );
          allMarkers.addLayer(marker);
        });

        map.addLayer(allMarkers);
      })
      .catch((error) => {
        console.error("Error loading JSON data:", error);
        alert("Failed to load map data.");
      });

    const baseLayers = {
      Satellite: esriSat,
      Streets: osm,
      Terrain: topo,
    };

    L.control.layers(baseLayers, null, { collapsed: false, position: "topright" }).addTo(map);
  </script>
</body>
</html>